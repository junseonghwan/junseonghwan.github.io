<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Object oriented programming in R w/ S4</title>
  <meta name="description" content="This post corresponds to my presentation at the UBC statistics department student seminar that took place on January 19th.">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="junseonghwan.github.io/2017/01/16/object-oriented-programming-in-r-s4.html">
  <link rel="alternate" type="application/rss+xml" title="Seong-Hwan Jun" href="junseonghwan.github.io/feed.xml" />

  

  <script type="text/javascript" async
    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
  </script>
  <!--
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>-->

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Seong-Hwan Jun</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
          <a class="page-link" href="/code/">Code</a>
          
        
          
        
          
        
          
          <a class="page-link" href="/research/">Research</a>
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Object oriented programming in R w/ S4</h1>
    <p class="post-meta">Jan 16, 2017</p>
  </header>

  <article class="post-content">
    <p>This post corresponds to my presentation at the UBC statistics department student seminar that took place on January 19th.</p>

<h2 id="introduction-to-oop-in-r">Introduction to OOP in R</h2>

<p>There are situations where the latent variable of interest take on a discrete structure. How can we represent this type of structure in R? One way to do this in R is to use object oriented programming.</p>

<p>This post will go over basics of S4 and in the process, cover two key principles of OOP: <strong>encapsulation</strong> and <strong>abstraction</strong>. In the next post, we will see how <em>inheritance</em> and <em>polymorphism</em> is achieved in R using S4.</p>

<h2 id="phylogenetics-tree">Phylogenetics tree</h2>

<p>We will build a phylogeneics tree using S4. Note that there already exists a package that allows you to build a tree in R such as <a href="https://cran.r-project.org/web/packages/data.tree/vignettes/data.tree.html"><code class="highlighter-rouge">data.tree</code></a> and <a href="https://cran.r-project.org/web/packages/phylobase/vignettes/phylobase.pdf"><code class="highlighter-rouge">phylo4</code></a>. But we will build our own so that we get to practice with S4 concepts.</p>

<p>Let’s build a simple phylogenetics tree. We want each node of the tree to hold the name of the node (for example, the specie name) and the DNA sequence. Each node of the tree needs to keep track of its children nodes as well. In Java, we would do this via recursive class definition:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PhyloTreeNode</span>
<span class="o">{</span>
	<span class="c1">// fields:</span>
	<span class="kd">public</span> <span class="n">PhyloTreeNode</span> <span class="n">left</span><span class="o">;</span>
	<span class="kd">public</span> <span class="n">PhyloTreeNode</span> <span class="n">right</span><span class="o">;</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="n">specie</span><span class="o">;</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="n">sequence</span><span class="o">;</span>

	<span class="c1">// constructor</span>
	<span class="kd">public</span> <span class="nf">PhyloTreeNode</span><span class="o">(</span><span class="n">PhyloTreeNode</span> <span class="n">l</span><span class="o">,</span> <span class="n">PhyloTreeNode</span> <span class="n">r</span><span class="o">,</span> <span class="n">String</span> <span class="n">specie</span><span class="o">,</span> <span class="n">String</span> <span class="n">seq</span><span class="o">)</span> 
	<span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">l</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">specie</span> <span class="o">=</span> <span class="n">specie</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">sequence</span> <span class="o">=</span> <span class="n">seq</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="c1">// getter and setter and other methods go here</span>
<span class="o">}</span>
</code></pre>
</div>

<h1 id="defining-a-class">Defining a class</h1>

<p>Now, let’s see how we can do this in R. Key functions:</p>

<ul>
  <li><code class="highlighter-rouge">setClass</code></li>
  <li><code class="highlighter-rouge">new</code></li>
</ul>

<p>We declare S4 class using <code class="highlighter-rouge">setClass(...)</code> method and instantiate an object using <code class="highlighter-rouge">new(...)</code>. In R, the fields are referred to as <em>slots</em>. We will create slots <code class="highlighter-rouge">specie</code> and <code class="highlighter-rouge">sequence</code> as primitive type <code class="highlighter-rouge">character</code>. You can specify the values for these slots when you instantiate an object:</p>

<div class="language-R highlighter-rouge"><pre class="highlight"><code><span class="n">setClass</span><span class="p">(</span><span class="s2">"PhyloTreeNode"</span><span class="p">,</span><span class="w"> </span><span class="n">slots</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="n">specie</span><span class="o">=</span><span class="s2">"character"</span><span class="p">,</span><span class="w"> </span><span class="n">sequence</span><span class="o">=</span><span class="s2">"character"</span><span class="p">))</span><span class="w">
</span><span class="n">root</span><span class="o">&lt;-</span><span class="n">new</span><span class="p">(</span><span class="s2">"PhyloTreeNode"</span><span class="p">,</span><span class="w"> </span><span class="n">specie</span><span class="o">=</span><span class="s2">"homo sapiens"</span><span class="p">,</span><span class="w"> </span><span class="n">sequence</span><span class="o">=</span><span class="s2">"AACCGGTT"</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<p>What about the children nodes? Unfortunately, S4 does not allow for recursive class definition:</p>

<div class="language-R highlighter-rouge"><pre class="highlight"><code><span class="c1"># first remove the class definition from your environment
</span><span class="n">removeClass</span><span class="p">(</span><span class="s2">"PhyloTreeNode"</span><span class="p">)</span><span class="w"> 
</span><span class="n">setClass</span><span class="p">(</span><span class="s2">"PhyloTreeNode"</span><span class="p">,</span><span class="w"> </span><span class="n">slots</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="n">specie</span><span class="o">=</span><span class="s2">"character"</span><span class="p">,</span><span class="w"> 
                                  </span><span class="n">sequence</span><span class="o">=</span><span class="s2">"character"</span><span class="p">,</span><span class="w"> 
                                  </span><span class="n">left</span><span class="o">=</span><span class="s2">"PhyloTreeNode"</span><span class="p">,</span><span class="w"> 
                                  </span><span class="n">right</span><span class="o">=</span><span class="s2">"PhyloTreeNode"</span><span class="p">))</span><span class="w">
</span><span class="c1">#Warning message:
#undefined slot classes in definition of "PhyloTreeNode": left(class "PhyloTreeNode"), right(class "PhyloTreeNode") 
</span><span class="w">
</span><span class="n">root</span><span class="o">&lt;-</span><span class="n">new</span><span class="p">(</span><span class="s2">"PhyloTreeNode"</span><span class="p">,</span><span class="w"> </span><span class="n">specie</span><span class="o">=</span><span class="s2">"homo sapiens"</span><span class="p">,</span><span class="w"> </span><span class="n">sequence</span><span class="o">=</span><span class="s2">"AACCGGTT"</span><span class="p">,</span><span class="w"> </span><span class="n">left</span><span class="o">=</span><span class="kc">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">right</span><span class="o">=</span><span class="kc">NULL</span><span class="p">)</span><span class="w">
</span><span class="c1">#Error in validObject(.Object) : 
#  invalid class “PhyloTreeNode” object: 1: invalid object for slot "left" in class "PhyloTreeNode": got class "NULL", should be or extend class "PhyloTreeNode"
# invalid class “PhyloTreeNode” object: 2: invalid object for slot "right" in class "PhyloTreeNode": got class "NULL", should be or extend class "PhyloTreeNode"
</span></code></pre>
</div>

<p>One work around is to store the children as a <code class="highlighter-rouge">list</code>:</p>

<div class="language-R highlighter-rouge"><pre class="highlight"><code><span class="n">setClass</span><span class="p">(</span><span class="s2">"PhyloTreeNode"</span><span class="p">,</span><span class="w"> </span><span class="n">slots</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="n">specie</span><span class="o">=</span><span class="s2">"character"</span><span class="p">,</span><span class="w"> </span><span class="n">sequence</span><span class="o">=</span><span class="s2">"character"</span><span class="p">,</span><span class="w"> </span><span class="n">children</span><span class="o">=</span><span class="s2">"list"</span><span class="p">))</span><span class="w">
</span><span class="n">human</span><span class="o">&lt;-</span><span class="n">new</span><span class="p">(</span><span class="s2">"PhyloTreeNode"</span><span class="p">,</span><span class="w"> </span><span class="n">specie</span><span class="o">=</span><span class="s2">"homo sapiens"</span><span class="p">,</span><span class="w"> </span><span class="n">sequence</span><span class="o">=</span><span class="s2">"AACCGGTT"</span><span class="p">)</span><span class="w">
</span><span class="n">human</span><span class="o">@</span><span class="n">children</span><span class="w">
</span></code></pre>
</div>

<p>Now, let’s create some additional nodes and build a simple tree with three nodes, root, and two children (leaf) nodes. We will first do it in a <strong>bad</strong> way (anti-OOP way):</p>

<div class="language-R highlighter-rouge"><pre class="highlight"><code><span class="c1"># create an ancestor specie for human
</span><span class="n">australopithecus</span><span class="o">&lt;-</span><span class="n">new</span><span class="p">(</span><span class="s2">"PhyloTreeNode"</span><span class="p">,</span><span class="w"> </span><span class="n">specie</span><span class="o">=</span><span class="s2">"australopithecus"</span><span class="p">,</span><span class="w"> </span><span class="n">sequence</span><span class="o">=</span><span class="s2">"ACACGGGT"</span><span class="p">)</span><span class="w">

</span><span class="c1"># create human specie
</span><span class="n">human</span><span class="o">&lt;-</span><span class="n">new</span><span class="p">(</span><span class="s2">"PhyloTreeNode"</span><span class="p">,</span><span class="w"> </span><span class="n">specie</span><span class="o">=</span><span class="s2">"homo sapiens"</span><span class="p">,</span><span class="w"> </span><span class="n">sequence</span><span class="o">=</span><span class="s2">"AACCGGTT"</span><span class="p">)</span><span class="w">

</span><span class="c1"># create a sibling specie for human
</span><span class="n">neanderthal</span><span class="o">&lt;-</span><span class="n">new</span><span class="p">(</span><span class="s2">"PhyloTreeNode"</span><span class="p">,</span><span class="w"> </span><span class="n">specie</span><span class="o">=</span><span class="s2">"homo neanderthalensis"</span><span class="p">,</span><span class="w"> </span><span class="n">sequence</span><span class="o">=</span><span class="s2">"AACCGGGT"</span><span class="p">)</span><span class="w">

</span><span class="n">australopithecus</span><span class="o">@</span><span class="n">children</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span><span class="o">&lt;-</span><span class="n">human</span><span class="w">
</span><span class="n">australopithecus</span><span class="o">@</span><span class="n">children</span><span class="p">[[</span><span class="m">2</span><span class="p">]]</span><span class="o">&lt;-</span><span class="n">australopithecus</span><span class="o">@</span><span class="n">children</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span><span class="o">&lt;-</span><span class="n">human</span><span class="w">
</span><span class="n">australopithecus</span><span class="o">@</span><span class="n">children</span><span class="w">
</span></code></pre>
</div>

<p>This way of directly adding the children nodes works… but it breaks an important OOP principle: encapsulation.  However, it does not seem possible in R to fully implement encapsulation because unlike in Java, keywords such as private, public, protected, etc are not offered in R. So the fields cannot be hidden away from the users. There isn’t a perfect solution, but what we can do is to provide methods (functions) for adding children nodes and thereby, discourage the users from needing to access the fields directly.</p>

<h1 id="defining-methods-for-classes">Defining methods for classes</h1>

<p>R functions covered:</p>

<ul>
  <li><code class="highlighter-rouge">setGeneric</code></li>
  <li><code class="highlighter-rouge">standardGeneric</code></li>
  <li><code class="highlighter-rouge">setMethod</code></li>
  <li><code class="highlighter-rouge">signature</code></li>
  <li><code class="highlighter-rouge">showMethods</code></li>
</ul>

<p>The first thing we need to do is to declare the function name:</p>

<div class="language-R highlighter-rouge"><pre class="highlight"><code><span class="n">setGeneric</span><span class="p">(</span><span class="s2">"addChild"</span><span class="p">,</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nf">standardGeneric</span><span class="p">(</span><span class="s2">"addChild"</span><span class="p">)</span><span class="w">
</span><span class="p">})</span><span class="w">
</span></code></pre>
</div>

<p>Now, we provide the method body for our class <code class="highlighter-rouge">PhyloTreeNode</code>:</p>

<div class="language-R highlighter-rouge"><pre class="highlight"><code><span class="n">setMethod</span><span class="p">(</span><span class="s2">"addChild"</span><span class="p">,</span><span class="w"> </span><span class="n">signature</span><span class="p">(</span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"PhyloTreeNode"</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"PhyloTreeNode"</span><span class="p">),</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">node</span><span class="o">@</span><span class="n">children</span><span class="p">[[</span><span class="nf">length</span><span class="p">(</span><span class="n">node</span><span class="o">@</span><span class="n">children</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">]]</span><span class="o">&lt;-</span><span class="n">child</span><span class="w">
  </span><span class="n">node</span><span class="w">
</span><span class="p">})</span><span class="w">

</span><span class="n">showMethods</span><span class="p">(</span><span class="s2">"addChild"</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<p>There are few things going on here:</p>

<ol>
  <li><code class="highlighter-rouge">setGeneric</code> declares a generic method with the name <code class="highlighter-rouge">addChild</code> (in the global environment). It calls <code class="highlighter-rouge">standardGeneric</code>, which basically handles method dispatching. For example, if there are more than one implementation of <code class="highlighter-rouge">addChild</code>, which one is to be called.</li>
  <li><code class="highlighter-rouge">setMethod</code> defines signature for the arguments as well as the function body.</li>
  <li>Definition of <code class="highlighter-rouge">setMethod</code> returns the <code class="highlighter-rouge">node</code> object back. This is because R, unlike Java, does not pass objects by reference so copies are made at each function calls.</li>
  <li><code class="highlighter-rouge">showMethods("addChild")</code> displays signature of all methods that implement <code class="highlighter-rouge">addChild</code>. This will be useful when we talk about inheritance and polymorphism as there will be multiple classes implementing the same method but with different signature and hence, offering different behaviors.</li>
</ol>

<p>Now, let’s add some nodes using <code class="highlighter-rouge">addChild(...)</code>:</p>

<div class="language-R highlighter-rouge"><pre class="highlight"><code><span class="n">watson</span><span class="o">&lt;-</span><span class="n">new</span><span class="p">(</span><span class="s2">"PhyloTreeNode"</span><span class="p">,</span><span class="w"> </span><span class="n">specie</span><span class="o">=</span><span class="s2">"ibm"</span><span class="p">,</span><span class="w"> </span><span class="n">sequence</span><span class="o">=</span><span class="s2">"AAAAAAAA"</span><span class="p">)</span><span class="w">
</span><span class="n">alphago</span><span class="o">&lt;-</span><span class="n">new</span><span class="p">(</span><span class="s2">"PhyloTreeNode"</span><span class="p">,</span><span class="w"> </span><span class="n">specie</span><span class="o">=</span><span class="s2">"deep mind"</span><span class="p">,</span><span class="w"> </span><span class="n">sequence</span><span class="o">=</span><span class="s2">"CCCCCCCC"</span><span class="p">)</span><span class="w">
</span><span class="n">human</span><span class="o">&lt;-</span><span class="n">addChild</span><span class="p">(</span><span class="n">human</span><span class="p">,</span><span class="w"> </span><span class="n">watson</span><span class="p">)</span><span class="w">
</span><span class="n">human</span><span class="o">&lt;-</span><span class="n">addChild</span><span class="p">(</span><span class="n">human</span><span class="p">,</span><span class="w"> </span><span class="n">alphago</span><span class="p">)</span><span class="w">
</span><span class="n">human</span><span class="o">@</span><span class="n">children</span><span class="w">
</span></code></pre>
</div>

<h3 id="why-are-encapsulation-and-abstraction-good-practice">Why are encapsulation and abstraction good practice?</h3>

<p>Imagine if you have modified the children slot directly to add children nodes. Say you have 1 million lines of such code. Now, say you decided to represent the children slot using another data structure – for example, data frame.  Now you are left with the task of modifying 1 million lines of code. With abstraction and encapsulation, it hides the details of your class implementation away so as long as your method signature remains unchanged, the users can continue to use your function even if you change the underlying representation of the slots. Another use case is, imagine if you wanted to enforce the strict condition that each node to contain at most two children. All you have to do is modify your <code class="highlighter-rouge">addChild</code> method as follows,</p>

<div class="language-R highlighter-rouge"><pre class="highlight"><code><span class="n">setMethod</span><span class="p">(</span><span class="s2">"addChild"</span><span class="p">,</span><span class="w"> </span><span class="n">signature</span><span class="p">(</span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"PhyloTreeNode"</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"PhyloTreeNode"</span><span class="p">),</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">node</span><span class="o">@</span><span class="n">children</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  		</span><span class="n">node</span><span class="o">@</span><span class="n">children</span><span class="p">[[</span><span class="nf">length</span><span class="p">(</span><span class="n">node</span><span class="o">@</span><span class="n">children</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">]]</span><span class="o">&lt;-</span><span class="n">child</span><span class="w">
  		</span><span class="n">node</span><span class="w">
	</span><span class="p">}</span><span class="w">
	</span><span class="n">print</span><span class="p">(</span><span class="s2">"Unable to add child node: this node already has 2 children nodes."</span><span class="p">)</span><span class="w">
	</span><span class="n">node</span><span class="w">
</span><span class="p">})</span><span class="w">

</span><span class="n">siri</span><span class="o">&lt;-</span><span class="n">new</span><span class="p">(</span><span class="s2">"PhyloTreeNode"</span><span class="p">,</span><span class="w"> </span><span class="n">specie</span><span class="o">=</span><span class="s2">"apple"</span><span class="p">,</span><span class="w"> </span><span class="n">sequence</span><span class="o">=</span><span class="s2">"AAAAAAAA"</span><span class="p">)</span><span class="w">
</span><span class="n">human</span><span class="o">&lt;-</span><span class="n">addChild</span><span class="p">(</span><span class="n">human</span><span class="p">,</span><span class="w"> </span><span class="n">siri</span><span class="p">)</span><span class="w">
</span><span class="c1"># [1] "Unable to add child node: this node already has 2 children."
</span></code></pre>
</div>

<p>So it’s easier to maintain your code and less room for bugs to creep in.</p>

<h3 id="r-objects-are-not-references-to-memory-locations">R objects are not references to memory locations</h3>

<p>Suppose we run the following code:</p>

<div class="language-R highlighter-rouge"><pre class="highlight"><code><span class="n">australopithecus</span><span class="o">&lt;-</span><span class="n">new</span><span class="p">(</span><span class="s2">"PhyloTreeNode"</span><span class="p">,</span><span class="w"> </span><span class="n">specie</span><span class="o">=</span><span class="s2">"australopithecus"</span><span class="p">,</span><span class="w"> </span><span class="n">sequence</span><span class="o">=</span><span class="s2">"ACACGGGT"</span><span class="p">)</span><span class="w">
</span><span class="n">human</span><span class="o">&lt;-</span><span class="n">new</span><span class="p">(</span><span class="s2">"PhyloTreeNode"</span><span class="p">,</span><span class="w"> </span><span class="n">specie</span><span class="o">=</span><span class="s2">"homo sapiens"</span><span class="p">,</span><span class="w"> </span><span class="n">sequence</span><span class="o">=</span><span class="s2">"AACCGGTT"</span><span class="p">)</span><span class="w">
</span><span class="n">neanderthal</span><span class="o">&lt;-</span><span class="n">new</span><span class="p">(</span><span class="s2">"PhyloTreeNode"</span><span class="p">,</span><span class="w"> </span><span class="n">specie</span><span class="o">=</span><span class="s2">"homo neanderthalensis"</span><span class="p">,</span><span class="w"> </span><span class="n">sequence</span><span class="o">=</span><span class="s2">"AACCGGGT"</span><span class="p">)</span><span class="w">

</span><span class="n">australopithecus</span><span class="o">@</span><span class="n">children</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span><span class="o">&lt;-</span><span class="n">human</span><span class="w">
</span><span class="n">australopithecus</span><span class="o">@</span><span class="n">children</span><span class="p">[[</span><span class="m">2</span><span class="p">]]</span><span class="o">&lt;-</span><span class="n">australopithecus</span><span class="o">@</span><span class="n">children</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span><span class="o">&lt;-</span><span class="n">human</span><span class="w">
</span><span class="n">australopithecus</span><span class="o">@</span><span class="n">children</span><span class="w">

</span><span class="n">watson</span><span class="o">&lt;-</span><span class="n">new</span><span class="p">(</span><span class="s2">"PhyloTreeNode"</span><span class="p">,</span><span class="w"> </span><span class="n">specie</span><span class="o">=</span><span class="s2">"ibm"</span><span class="p">,</span><span class="w"> </span><span class="n">sequence</span><span class="o">=</span><span class="s2">"AAAAAAAA"</span><span class="p">)</span><span class="w">
</span><span class="n">alphago</span><span class="o">&lt;-</span><span class="n">new</span><span class="p">(</span><span class="s2">"PhyloTreeNode"</span><span class="p">,</span><span class="w"> </span><span class="n">specie</span><span class="o">=</span><span class="s2">"deep mind"</span><span class="p">,</span><span class="w"> </span><span class="n">sequence</span><span class="o">=</span><span class="s2">"CCCCCCCC"</span><span class="p">)</span><span class="w">
</span><span class="n">human</span><span class="o">&lt;-</span><span class="n">addChild</span><span class="p">(</span><span class="n">human</span><span class="p">,</span><span class="w"> </span><span class="n">watson</span><span class="p">)</span><span class="w">
</span><span class="n">human</span><span class="o">&lt;-</span><span class="n">addChild</span><span class="p">(</span><span class="n">human</span><span class="p">,</span><span class="w"> </span><span class="n">alphago</span><span class="p">)</span><span class="w">

</span><span class="n">australopithecus</span><span class="o">@</span><span class="n">children</span><span class="w">
</span></code></pre>
</div>

<p>Then, we get the following output:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[[1]]
An object of class "PhyloTreeNode"
Slot "specie":
[1] "homo sapiens"

Slot "sequence":
[1] "AACCGGTT"

Slot "children":
list()


[[2]]
An object of class "PhyloTreeNode"
Slot "specie":
[1] "homo sapiens"

Slot "sequence":
[1] "AACCGGTT"

Slot "children":
list()
</code></pre>
</div>

<p><strong>Problem</strong>: Because R is not storing the reference to the <code class="highlighter-rouge">human</code> object, when we added children to human, it is not reflected in the copy held by <code class="highlighter-rouge">australopithecus</code>. The conclusion is that we cannot be representing the tree object as we do in Java (or any other programming languages with the concept of pointers and references).</p>

<p><strong>Solution</strong>: One possible solution is to represent the tree class so that it has access to all of the nodes in the tree. In fact, this is how <a href="https://cran.r-project.org/web/packages/phylobase/"><code class="highlighter-rouge">phylo4</code></a> works; the below is <code class="highlighter-rouge">phylo4-class.R</code> file containing the declaration of the <code class="highlighter-rouge">phylo4</code> class:</p>

<div class="language-R highlighter-rouge"><pre class="highlight"><code><span class="n">setClass</span><span class="p">(</span><span class="s2">"phylo4"</span><span class="p">,</span><span class="w">
         </span><span class="n">representation</span><span class="p">(</span><span class="n">edge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"matrix"</span><span class="p">,</span><span class="w">
                        </span><span class="n">edge.length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"numeric"</span><span class="p">,</span><span class="w">
                        </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"character"</span><span class="p">,</span><span class="w">
                        </span><span class="n">edge.label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"character"</span><span class="p">,</span><span class="w">
                        </span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"character"</span><span class="p">,</span><span class="w">
                        </span><span class="n">annote</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"list"</span><span class="p">),</span><span class="w">
         </span><span class="n">prototype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="w">
                        </span><span class="n">edge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w">
                            </span><span class="n">dimname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="kc">NULL</span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"ancestor"</span><span class="p">,</span><span class="w"> </span><span class="s2">"descendant"</span><span class="p">))),</span><span class="w">
                        </span><span class="n">edge.length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numeric</span><span class="p">(</span><span class="m">0</span><span class="p">),</span><span class="w">
                        </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">character</span><span class="p">(</span><span class="m">0</span><span class="p">),</span><span class="w">
                        </span><span class="n">edge.label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">character</span><span class="p">(</span><span class="m">0</span><span class="p">),</span><span class="w">
                        </span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"unknown"</span><span class="p">,</span><span class="w">
                        </span><span class="n">annote</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">()</span><span class="w">
                       </span><span class="p">),</span><span class="w">
         </span><span class="n">validity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkPhylo4</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<p>The edges of the tree are represented using matrix with two columns (one for ancestor and one for descendant) (for more details on each of these fields, see page 14 of this <a href="https://cran.r-project.org/web/packages/phylobase/vignettes/phylobase.pdf">document</a>).</p>

<p>I plan to play around a bit with <code class="highlighter-rouge">phylo4</code> package. In the next post, I will post some code on how to use this package and illustrate the internal workings of this package in the hope that we can fully explore the features of S4 (including inheritance and polymorphism).</p>

<h1 id="exercise-writing-a-generic-sequential-monte-carlo-sampler-with-oop">Exercise: Writing a generic sequential Monte Carlo sampler with OOP</h1>

<p>Suppose we want to write a generic SMC algorithm, that can work on any state space. How can OOP be of use in this case?</p>

<p>My solution to this exercise to come in the next series of posts :)</p>

<h1 id="extra-other-features-of-s4">Extra: Other features of S4</h1>

<p>Depending on your needs, you may want to provide default values for the slots by setting the <code class="highlighter-rouge">prototype</code> field of the <code class="highlighter-rouge">setClass</code> function as follows,</p>

<div class="language-R highlighter-rouge"><pre class="highlight"><code><span class="n">setClass</span><span class="p">(</span><span class="s2">"PhyloTreeNode"</span><span class="p">,</span><span class="w"> </span><span class="n">slots</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="n">specie</span><span class="o">=</span><span class="s2">"character"</span><span class="p">,</span><span class="w"> </span><span class="n">sequence</span><span class="o">=</span><span class="s2">"character"</span><span class="p">),</span><span class="w"> </span><span class="n">prototype</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">specie</span><span class="o">=</span><span class="s2">"test_specie"</span><span class="p">,</span><span class="w"> </span><span class="n">sequence</span><span class="o">=</span><span class="s2">"ACGT"</span><span class="p">))</span><span class="w">
</span><span class="n">root</span><span class="o">&lt;-</span><span class="n">new</span><span class="p">(</span><span class="s2">"PhyloTreeNode"</span><span class="p">)</span><span class="w">
</span><span class="n">print</span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<p>If upon instantiation, you want to validate that the object is constructed properly, you can define a function and specify the function in the <code class="highlighter-rouge">validity</code> field. For example, suppose we want to ensure that the specie name is always provided:</p>

<div class="language-R highlighter-rouge"><pre class="highlight"><code><span class="n">validate_phylo_node</span><span class="o">&lt;-</span><span class="k">function</span><span class="p">(</span><span class="n">object</span><span class="p">)</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">object</span><span class="o">@</span><span class="n">specie</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">
        </span><span class="nf">return</span><span class="p">(</span><span class="s2">"Specify specie name."</span><span class="p">)</span><span class="w">
    </span><span class="kc">TRUE</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">setClass</span><span class="p">(</span><span class="s2">"PhyloTreeNode"</span><span class="p">,</span><span class="w"> 
         </span><span class="n">slots</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="n">specie</span><span class="o">=</span><span class="s2">"character"</span><span class="p">,</span><span class="w"> 
         </span><span class="n">sequence</span><span class="o">=</span><span class="s2">"character"</span><span class="p">,</span><span class="w"> </span><span class="n">children</span><span class="o">=</span><span class="s2">"list"</span><span class="p">),</span><span class="w"> 
         </span><span class="n">validity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">validate_phylo_node</span><span class="p">)</span><span class="w">

</span><span class="n">root</span><span class="o">&lt;-</span><span class="n">new</span><span class="p">(</span><span class="s2">"PhyloTreeNode"</span><span class="p">,</span><span class="w"> </span><span class="n">sequence</span><span class="o">=</span><span class="s2">"AAAAA"</span><span class="p">)</span><span class="w">
</span><span class="c1"># Error in validObject(.Object) : 
#  invalid class “PhyloTreeNode” object: Specify specie name. 
</span></code></pre>
</div>

<p>One interesting note: instantiating the object without any argument, for example, <code class="highlighter-rouge">new("PhyloTreeNode")</code> does not fire up the validation function. This may be related to the concept of virtual class (virtual class as in C++) in the sense that when we instantiate an object without any of the slots specified, it seems to be instantiating from a virtual class of the same name. But I am not 100% sure on this, so I will have to look into this a bit more.</p>

<h1 id="some-useful-references">Some useful references</h1>

<ul>
  <li><a href="https://cran.r-project.org/doc/manuals/r-release/R-ints.html#Mechanics-of-S4-dispatch">R Internals: Mechanics of S4 dispatch</a></li>
  <li>R manuals on S4:
    <ul>
      <li><a href="https://stat.ethz.ch/R-manual/R-devel/library/methods/html/Introduction.html">Intro</a></li>
      <li><a href="https://stat.ethz.ch/R-manual/R-devel/library/methods/html/Methods_Details.html">Methods details</a></li>
    </ul>
  </li>
  <li>Hadley Wickham’s book: Advanced R:
    <ul>
      <li><a href="http://adv-r.had.co.nz/S4.html">S4</a></li>
      <li><a href="http://adv-r.had.co.nz/memory.html">Memory</a></li>
    </ul>
  </li>
  <li><a href="http://stackoverflow.com/questions/7466388/how-to-set-default-value-of-a-slot-as-null-in-r"><code class="highlighter-rouge">setClassUnion</code></a>?</li>
</ul>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

<!--    <h2 class="footer-heading">Seong-Hwan Jun</h2> -->

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-3">
        <ul class="contact-list">
          <li>Address:</li>
          <li>Seong-Hwan Jun</li>
          <li>Department of Statistics,</li> 
          <li>University of British Columbia,</li>
          <li>3182 Earth Sciences Building,</li>
          <li>2207 Main Mall,</li>
          <li>Vancouver, BC, Canada V6T 1Z4</li>
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <ul class="social-media-list">
          <li>Email: seong dot jun AT stat dot ubc dot ca</li>

          
          <li>
            <a href="https://github.com/junseonghwan">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">junseonghwan</span>
            </a>
          </li>
          

          
        </ul>
      </div>
<!--
      <div class="footer-col  footer-col-3">
        <p class="text"></p>
      </div>
    </div>
-->
  </div>

</footer>


  </body>

</html>
